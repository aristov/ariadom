<!doctype html>
<html>
<head>
    <meta charset=utf-8>
    <meta name=viewport content="width=device-width,maximum-scale=1,initial-scale=1,user-scalable=0">

    <title>ARIADOM: Yandex style</title>

    <script src=../design/role.js></script>
    <script src=../design/ARIAButton.js></script>
    <script src=../design/ARIACheckBox.js></script>
    <script src=../design/ARIARadioGroup.js></script>
    <script src=../design/ARIAListBox.js></script>
    <script src=../design/ARIAHTMLTextBox.js></script>
    <script>
        ARIAButton.attachToDocument();
        ARIACheckBox.attachToDocument();
        ARIARadioGroup.attachToDocument();
        ARIAListBox.attachToDocument();
        ARIAHTMLTextBox.attachToDocument();

        document.addEventListener('click', function() {}); // cure for iOS
    </script>
    <script src=domTransform.js></script>

    <link rel=stylesheet href=../style/yandex.css>
    <style>
        article
        {
            display: inline-block;
            padding: 0 20px;
            margin-right: 80px;
            vertical-align: top;
        }
        section
        {
            margin: 20px 0;
        }
    </style>
</head>
<body>
<script>
    var xhr = new XMLHttpRequest(),
        domTransform = new DOMTransform();

    xhr.addEventListener('load', onLoad);
    xhr.open('GET', 'index.xml');
    xhr.send();

    function onLoad(event) {
        var ts = Date.now();

        document.body.appendChild(domTransform.apply(this.responseXML.documentElement));
        console.log(Date.now() - ts);
    }

    //================================================================================================

    domTransform.element('_', {
        attributes : {
            label : function(name, value) {
                if(value) this.target.setAttribute('aria-label', value);
            }
        },
        _attributes : function(attrs) {
            return { 'aria-label' : attrs.label };
        }
    });

    domTransform.element('root', { tagName : 'div' });

    domTransform.element('heading', {
        tagName : function(tagName) {
            return 'h' + (this.source.getAttribute('level') || '1');
        },
        _element : function(name) {
            return 'h' + (this.attributes.level || '1');
        },
        _attributes : { level : undefined }
    });

    domTransform.element('link', {
        tagName : 'a',
        attributes : {
            view : function(name, value) {
                this.target.classList.add(value || 'link');
            },
            mix : function(name, value) {
                if(value) this.target.classList.add(value);
            }
        },
        _classes : function(attrs) {
            return [attrs.view || 'link', attrs.mix];
        }
    });

    domTransform.element('button', {
        tagName : 'span',
        attributes : {
            role : 'button',
            disabled : function(name, value) {
                value === 'true'?
                    this.target.setAttribute('aria-disabled', 'true') :
                    this.target.tabIndex = 0;
            },
            pressed : function(name, value) {
                if(value) this.target.setAttribute('aria-pressed', value);
            },
            view : function(name, value) {
                this.target.classList.add(value || 'button');
            }
        },
        _attributes : function(attrs) {
            return {
                role : 'button',
                tabindex : attrs.disabled === 'true'? undefined : '0',
                'aria-disabled' : attrs.disabled,
                'aria-pressed' : attrs.pressed,
                'class' : attrs.view || 'button'
            };
        }
    });

    domTransform.element('checkbox', {
        tagName : 'span',
        attributes : {
            role : 'checkbox',
            disabled : function(name, value) {
                this.target.setAttribute('aria-disabled', value || 'false');
            },
            tabindex : function(name, value) {
                if(this.source.getAttribute('disabled') !== 'true') return '0';
            },
            checked : function(name, value) {
                if(value) this.target.setAttribute('aria-checked', value);
            },
            view : function(name, value) {
                var view = value || 'checkbox';
                this.target.classList.add(view);
                if(view === 'checkbox') {
                    var box = this.createElement('span', { 'class' : 'box' });
                    this.target.appendChild(box);
                }
            }
        },
        _attributes : function(attrs) {
            return {
                role : 'checkbox',
                tabindex : attrs.disabled === 'true'? undefined : '0',
                'aria-disabled' : attrs.disabled,
                'aria-checked' : attrs.checked,
                'class' : attrs.view || 'checkbox'
            };
        },
        _content : function(content) {
            return [{ element : 'box' }, content];
        }
    });

    domTransform.element('radiogroup', {
        tagName : 'span',
        attributes : {
            role : 'radiogroup',
            disabled : function(name, value) {
                if(value === 'true') {
                    this.target.setAttribute('aria-disabled', 'true');
                } else {
                    var source = this.source,
                        checked = source.querySelector('radio[checked=true]');
                    (checked || source.querySelector('radio'))
                        .setAttribute('tabindex', '0');
                }
            },
            view : function(name, value) {
                var view = value || 'radiogroup';
                this.target.classList.add(view);
                if(value === 'buttongroup') {
                    Array.prototype.forEach.call(
                        this.source.querySelectorAll('radio'),
                        function(radio) {
                            radio.setAttribute('view', 'button');
                        });
                }
            }
        },
        _attributes : function(attrs) {
            return {
                role : 'radiogroup',
                'aria-disabled' : attrs.disabled,
                'class' : attrs.view || 'radiogroup'
            };
        },
        children : {}
    });

    domTransform.element('radio', {
        tagName : 'span',
        attributes : {
            role : 'radio',
            checked : function(name, value) {
                if(value === 'true')
                    this.target.setAttribute('aria-checked', 'true');
            },
            view : function(name, value) {
                var view = value || 'radio',
                    target = this.target;
                target.classList.add(view);
                if(view === 'radio') {
                    var box = this.createElement('span', { 'class' : 'box' });
                    target.appendChild(box);
                }
            },
            tabindex : function(name, value) {
                if(!this.isDisabled()) return value || '-1';
            }
        },
        _element : 'span',
        _attributes : function(attrs) {
            return {
                role : 'radio',
                tabindex : attrs.disabled === 'true'? undefined : '-1',
                'aria-checked' : attrs.checked,
                'class' : attrs.view || 'radio'
            };
        },
        _content : function(content) {
            return [{ element : 'box' }, content];
        },
        isDisabled : function() {
            var radiogroup = this.source.closest('radiogroup');
            return radiogroup.getAttribute('disabled') === 'true';
        }
    });

    domTransform.element('listbox', {
        tagName : 'span',
        attributes : {
            role : 'listbox',
            disabled : function(name, value) {
                value === 'true'?
                    this.target.setAttribute('aria-disabled', 'true') :
                    this.target.tabIndex = 0;
            },
            view : function(name, value) {
                this.target.classList.add(value || 'listbox');
            }
        },
        _attributes : function(attrs) {
            return {
                role : 'listbox',
                tabindex : attrs.disabled === 'true'? undefined : '-1',
                'aria-disabled' : attrs.disabled,
                'class' : attrs.view || 'listbox'
            };
        },
        content : function(content) {
            var box = this.createElement('span', { 'class' : 'box' });
            this.appendNodeList(content, box);
            return box;
        },
        _children : function(children) {
            return { element : 'box', children : children };
        }
    });

    domTransform.element('option', {
        tagName : 'span',
        attributes : {
            role : 'option',
            selected : function(name, value) {
                if(value) this.target.setAttribute('aria-selected', value);
            },
            checked : function(name, value) {
                if(value) this.target.setAttribute('aria-checked', value);
            },
            view : function(name, value) {
                this.target.classList.add(value || 'option');
            }
        },
        _attributes : function(attrs) {
            return {
                role : 'option',
                'aria-selected' : attrs.selected,
                'aria-checked' : attrs.checked,
                'class' : attrs.view || 'option'
            };
        },
    });

    domTransform.element('textbox', {
        tagName : 'span',
        attributes : {
            role : 'textbox',
            disabled : function(name, value) {
                if(value === 'true') this.target.classList.add('disabled');
            },
            view : function(name, value) {
                this.target.classList.add(value || 'textbox');
            }
        },
        _attributes : function(attrs) {
            return {
                role : 'textbox',
                'aria-disabled' : attrs.disabled,
                'class' : attrs.view || 'textbox'
            }
        },
        content : function() {
            var source = this.source,
                isMultiline = source.getAttribute('multiline') === 'true',
                tag = isMultiline? 'textarea' : 'input',
                input = this.createElement(tag, {
                    'class' : 'box',
                    autocomplete : 'off',
                    disabled : source.getAttribute('disabled') === 'true'
                });
            input.value = source.getAttribute('value');
            return input;
        },
        children : function(children) {
            var attrs = this.attrs;
            return {
                element : attrs.multiline? 'textarea' : 'input',
                attributes : {
                    autocomplete : 'off',
                    disabled : attrs.disabled,
                    value : attrs.value,
                    'class' : 'box'
                }
            };
        }
    });

    domTransform.element('buttongroup', {
        tagName : 'span',
        attributes : {
            view : function(name, value) {
                this.target.classList.add(value || 'buttongroup');
            }
        },
        _classes : function(attrs) {
            return [attrs.view || 'buttongroup'];
        }
    });
</script>
</body>
</html>

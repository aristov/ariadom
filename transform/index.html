<!doctype html>
<html>
<head>
    <meta charset=utf-8>
    <meta name=viewport content="width=device-width,maximum-scale=1,initial-scale=1,user-scalable=0">

    <title>ARIADOM: Yandex style</title>

    <script src=../design/role.js></script>
    <script src=../design/ARIAButton.js></script>
    <script src=../design/ARIACheckBox.js></script>
    <script src=../design/ARIARadioGroup.js></script>
    <script src=../design/ARIAListBox.js></script>
    <script src=../design/ARIAHTMLTextBox.js></script>
    <script>
        ARIAButton.attachToDocument();
        ARIACheckBox.attachToDocument();
        ARIARadioGroup.attachToDocument();
        ARIAListBox.attachToDocument();
        ARIAHTMLTextBox.attachToDocument();

        document.addEventListener('click', function() {}); // cure for iOS
    </script>

    <link rel=stylesheet href=../style/yandex.css>
    <style>
        article
        {
            display: inline-block;
            padding: 0 20px;
            margin-right: 80px;
            vertical-align: top;
        }
        section
        {
            margin: 20px 0;
        }
    </style>
</head>
<body>
<script>
    var xhr = new XMLHttpRequest(),
        forEach = Array.prototype.forEach;

    xhr.addEventListener('load', onLoad);
    xhr.open('GET', 'index.xml');
    xhr.send();

    function onLoad(event) {
        var ts = Date.now(),
            domTransform = new DOMTransform();

        document.body.appendChild(domTransform.apply(this.responseXML.documentElement));
        console.log(Date.now() - ts);
    }

    //================================================================================================

    function DOMTransform() {}

    DOMTransform.prototype.nodeTypes = {};

    DOMTransform.prototype.apply = function(node) {
        var template = this.nodeTypes[node.nodeType];
        return template? template.applyNode(node) : null;
    }

    function DOMTextTransform() {}

    DOMTextTransform.prototype = new DOMTransform();

    DOMTextTransform.prototype.applyNode = function(node) {
        return this.transform(node);
    }

    DOMTextTransform.prototype.transform = function(node) {
        return document.createTextNode(node.nodeValue);
    }

    DOMTransform.prototype.nodeTypes[Node.TEXT_NODE] = new DOMTextTransform();

    function DOMElementTransform() {}

    DOMElementTransform.prototype = new DOMTransform();

    DOMElementTransform.prototype.elements = {};
    DOMElementTransform.prototype.attributes = {};

    DOMElementTransform.prototype.applyNode = function(node) {
        var template = this.elements[node.nodeName];
        return template? template.transform(node) : this.transform(node);
    }

    DOMElementTransform.prototype.transform = function(node) {
        var result = this.createElement(node);
        if(node.hasAttributes()) this.applyAttributes(node, result);
        if(node.childNodes.length) this.applyChildNodes(node, result);
        return result;
    }

    DOMElementTransform.prototype.createElement = function(node) {
        return document.createElement(this.nodeName(node));
    }

    DOMElementTransform.prototype.nodeName = function(node) {
        return node.nodeName;
    }

    DOMElementTransform.prototype.applyAttributes = function(node, result) {
        forEach.call(node.attributes, function(attribute) {
            this.applyAttribute(attribute, node, result);
        }, this);
    }

    DOMElementTransform.prototype.applyAttribute = function(attribute, node, result) {
        var process = this.attributes[attribute.name];
        process? 
            process.call(this, attribute, node, result) : 
            this.processAttribute(attribute, node, result);
    }

    DOMElementTransform.prototype.processAttribute = function(attribute, node, result) {
        result.setAttribute(attribute.name, attribute.value);
    }

    DOMElementTransform.prototype.applyChildNodes = function(node, result) {
        forEach.call(node.childNodes, function(childNode) {
            this.processChildNode(childNode, node, result);
        }, this);
    }

    DOMElementTransform.prototype.processChildNode = function(childNode, node, result) {
        var child = this.apply(childNode);
        if(child) this.appendChild(child, node, result);
    }

    DOMElementTransform.prototype.appendChild = function(child, node, result) {
        result.appendChild(child);
    }

    DOMTransform.prototype.nodeTypes[Node.ELEMENT_NODE] = new DOMElementTransform();

    function DOMARIATransform() {}

    DOMARIATransform.prototype = new DOMElementTransform();

    DOMARIATransform.prototype.transform = function(node) {
        var result = DOMElementTransform.prototype.transform.call(this, node);
        result.setAttribute('role', node.nodeName);
        result.classList.add(node.nodeName);
        return result;
    }

    DOMARIATransform.prototype.nodeName = function(node) {
        return 'span';
    }

    DOMARIATransform.prototype.processAttribute = function(attribute, node, result) {
        var name = attribute.name;
        this.aria[name]?
            result.setAttribute('aria-' + name, attribute.value) :
            DOMElementTransform.prototype.processAttribute(attribute, node, result);
    }

    DOMARIATransform.prototype.setTabIndex = function(node, result) {
        if(node.getAttribute('disabled') !== 'true') result.tabIndex = 0;
    }

    DOMARIATransform.prototype.createBoxElement = function() {
        var box = document.createElement('span');
        box.classList.add('box');
        return box;
    }

    DOMARIATransform.prototype.aria = {
        activedescendant : true,
        atomic : true,
        autocomplete : true,
        busy : true,
        checked : true,
        colcount : true,
        colindex : true,
        colspan : true,
        controls : true,
        current : true,
        describedat : true,
        describedby : true,
        disabled : true,
        dropeffect : true,
        errormessage : true,
        expanded : true,
        flowto : true,
        grabbed : true,
        haspopup : true,
        hidden : true,
        invalid : true,
        kbdshortcuts : true,
        label : true,
        labelledby : true,
        level : true,
        live : true,
        modal : true,
        multiline : true,
        multiselectable : true,
        orientation : true,
        owns : true,
        placeholder : true,
        posinset : true,
        pressed : true,
        readonly : true,
        relevant : true,
        required : true,
        roledescription : true,
        rowcount : true,
        rowindex : true,
        rowspan : true,
        selected : true,
        setsize : true,
        sort : true,
        valuemax : true,
        valuemin : true,
        valuenow : true,
        valuetext : true
    };

    void function() {
        var root = new DOMElementTransform();
        root.nodeName = function(node) {
            return 'div';
        }
        DOMElementTransform.prototype.elements.root = root;
    }();

    void function() {
        var heading = new DOMElementTransform();
        heading.nodeName = function(node) {
            return 'h' + (node.getAttribute('level') || 1);
        }
        DOMElementTransform.prototype.elements.heading = heading;
    }();

    void function() {
        var link = new DOMElementTransform();
        link.nodeName = function(node) {
            return 'a';
        }
        link.transform = function(node) {
            var result = DOMElementTransform.prototype.transform.call(this, node);
            result.classList.add('link');
            return result;
        }
        DOMARIATransform.prototype.elements.link = link;
    }();

    void function() {
        var button = new DOMARIATransform();
        button.transform = function(node) {
            var result = DOMARIATransform.prototype.transform.call(this, node);
            this.setTabIndex(node, result);
            return result;
        }
        DOMARIATransform.prototype.elements.button = button;
    }();

    void function() {
        var checkbox = new DOMARIATransform();
        checkbox.transform = function(node) {
            var result = DOMARIATransform.prototype.transform.call(this, node);
            this.setTabIndex(node, result);
            return result;
        }
        checkbox.applyChildNodes = function(node, result) {
            result.appendChild(this.createBoxElement());
            DOMARIATransform.prototype.applyChildNodes.call(this, node, result);
        }
        DOMARIATransform.prototype.elements.checkbox = checkbox;
    }();

    void function() {
        DOMARIATransform.prototype.elements.radiogroup = new DOMARIATransform();
    }();

    void function() {
        var radio = new DOMARIATransform();
        radio.transform = function(node) {
            var result = DOMARIATransform.prototype.transform.call(this, node),
                radiogroup = node.closest('radiogroup'),
                first = radiogroup.querySelector('radio'),
                checked = radiogroup.querySelector('radio[checked=true]'),
                disabled = node.getAttribute('disabled') === 'true' ||
                    radiogroup.getAttribute('disabled') === 'true';
            if(!disabled)
                result.tabIndex = (!checked && node === first) || node === checked? 0 : -1;
            return result;
        }
        radio.applyChildNodes = function(node, result) {
            result.appendChild(this.createBoxElement());
            DOMARIATransform.prototype.applyChildNodes.call(this, node, result);
        }
        DOMARIATransform.prototype.elements.radio = radio;
    }();

    void function() {
        var listbox = new DOMARIATransform();
        listbox.transform = function(node) {
            var result = DOMARIATransform.prototype.transform.call(this, node);
            this.setTabIndex(node, result);
            return result;
        }
        listbox.applyChildNodes = function(node, result) {
            result.appendChild(this.box = this.createBoxElement());
            DOMARIATransform.prototype.applyChildNodes.call(this, node, result);
        }
        listbox.appendChild = function(child, result) {
            this.box.appendChild(child);
        }
        DOMARIATransform.prototype.elements.listbox = listbox;
    }();

    void function() {
        DOMARIATransform.prototype.elements.option = new DOMARIATransform();
    }();

    void function() {
        var textbox = new DOMARIATransform();
        textbox.transform = function(node) {
            var result = DOMARIATransform.prototype.transform.call(this, node),
                box = document.createElement('input'),
                value = node.getAttribute('value');
            box.setAttribute('autocomplete', 'off');
            box.classList.add('box');
            if(typeof value === 'string') box.setAttribute('value', value);
            if(node.getAttribute('disabled') === 'true') {
                result.classList.add('disabled');
                box.disabled = true;
            }
            result.appendChild(box);
            return result;
        }
        DOMARIATransform.prototype.elements.textbox = textbox;
    }();
</script>
</body>
</html>

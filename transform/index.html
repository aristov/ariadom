<!doctype html>
<html>
<head>
    <meta charset=utf-8>
    <meta name=viewport content="width=device-width,maximum-scale=1,initial-scale=1,user-scalable=0">

    <title>ARIADOM: Yandex style</title>

    <script src=../design/role.js></script>
    <script src=../design/ARIAButton.js></script>
    <script src=../design/ARIACheckBox.js></script>
    <script src=../design/ARIARadioGroup.js></script>
    <script src=../design/ARIAListBox.js></script>
    <script src=../design/ARIAHTMLTextBox.js></script>
    <script>
        ARIAButton.attachToDocument();
        ARIACheckBox.attachToDocument();
        ARIARadioGroup.attachToDocument();
        ARIAListBox.attachToDocument();
        ARIAHTMLTextBox.attachToDocument();

        document.addEventListener('click', function() {}); // cure for iOS
    </script>

    <link rel=stylesheet href=../style/yandex.css>
    <style>
        article
        {
            display: inline-block;
            padding: 0 20px;
            margin-right: 80px;
            vertical-align: top;
        }
        section
        {
            margin: 20px 0;
        }
    </style>
</head>
<body>
<script>
    var xhr = new XMLHttpRequest(),
        forEach = Array.prototype.forEach;

    xhr.addEventListener('load', onLoad);
    xhr.open('GET', 'index.xml');
    xhr.send();

    function onLoad(event) {
        var ts = Date.now(),
            domTransform = new DOMTransform();

        document.body.appendChild(domTransform.apply(this.responseXML.documentElement));
        console.log(Date.now() - ts);
    }

    //================================================================================================

    function DOMTransform() {}

    DOMTransform.prototype.nodeTypes = {};

    DOMTransform.prototype.apply = function(node) {
        var template = this.nodeTypes[node.nodeType];
        return template? template.process(node) : null;
    }

    function DOMTextTransform() {
        this.constructor = DOMTextTransform;
    }

    DOMTextTransform.prototype = new DOMTransform();

    DOMTextTransform.prototype.process = function(node) {
        this.node = node;
        return this.transform();
    }

    DOMTextTransform.prototype.transform = function() {
        return document.createTextNode(this.node.nodeValue);
    }

    DOMTransform.prototype.nodeTypes[Node.TEXT_NODE] = new DOMTextTransform();

    function DOMElementTransform() {
        this.constructor = DOMElementTransform;
    }

    DOMElementTransform.prototype = new DOMTransform();

    DOMElementTransform.prototype.element = null;
    DOMElementTransform.prototype.result = null;
    DOMElementTransform.prototype.className = '';

    DOMElementTransform.prototype.elements = {};
    DOMElementTransform.prototype.attributes = {};

    DOMElementTransform.prototype.process = function(element) {
        var template = this.elements[element.tagName] || this;
        template.element = element;
        return template.transform();
    }

    DOMElementTransform.prototype.transform = function() {
        var result = this.result = document.createElement(this.tagName);
        this.applyAttributes();
        this.applyClassName();
        this.applyChildNodes();
        return result;
    }

    Object.defineProperty(DOMElementTransform.prototype, 'tagName', {
        configurable : true,
        enumerable : true,
        get : function() {
            return this.element.tagName;
        }
    });

    DOMElementTransform.prototype.createElement = function(name, attrs) {
        var element = document.createElement(name);
        if(attrs) for(var attr in attrs) element.setAttribute(attr, attrs[attr]);
        return element;
    }

    DOMElementTransform.prototype.applyAttributes = function() {
        var _this = this,
            attrs = Array.prototype.reduce.call(
                this.element.attributes,
                function(res, attribute) {
                    res[attribute.name] = attribute.value;
                    return res;
                }, {}),
            name;

        for(name in this.attributes) attrs[name] = this.attributes[name];
        for(name in attrs) this.applyAttribute(name, attrs[name]);
    }

    DOMElementTransform.prototype.applyAttribute = function(name, value) {
        if(typeof value === 'function')
            value = value.call(this, name, this.element.getAttribute(name));
        if(typeof value !== 'undefined')
            this.result.setAttribute(name, value);
    }

    DOMElementTransform.prototype.applyClassName = function() {
        if(this.className) this.result.className = this.className;
    }

    DOMElementTransform.prototype.applyChildNodes = function() {
        var result = this.result;
        forEach.call(this.element.childNodes, function(childNode) {
            this.processChildNode(childNode);
            this.result = result;
        }, this);
    }

    DOMElementTransform.prototype.processChildNode = function(childNode) {
        var result = this.result,
            child = this.apply(childNode);
        if(child) result.appendChild(child);
    }

    DOMTransform.prototype.nodeTypes[Node.ELEMENT_NODE] = new DOMElementTransform();

    DOMTransform.element = function(name, template) {
        var element = new DOMElementTransform();
        if(template.tagName) {
            Object.defineProperty(element, 'tagName', {
                enumerable : true,
                configurable : true,
                writable : true,
                value : template.tagName
            });
        }
        if(template.attributes) element.attributes = template.attributes;
        if(template.className) element.className = template.className;
        DOMElementTransform.prototype.elements[name] = element;
    }

    DOMTransform.element('root', { tagName : 'div' });

    DOMTransform.element('heading', { tagName : 'h1' });

    DOMTransform.element('link', {
        tagName : 'a',
        attributes : {
            view : function(name, value) {
                this.result.classList.add(value || 'link');
            },
            mix : function(name, value) {
                if(value) this.result.classList.add(value);
            }
        }
    });

    DOMTransform.element('button', {
        tagName : 'span',
        attributes : {
            role : 'button',
            disabled : function(name, value) {
                value === 'true'?
                    this.result.setAttribute('aria-disabled', 'true') :
                    this.result.tabIndex = 0;
            },
            pressed : function(name, value) {
                if(value) this.result.setAttribute('aria-pressed', value);
            },
            view : function(name, value) {
                this.result.classList.add(value || 'button');
            }
        }
    });

    DOMTransform.element('checkbox', {
        tagName : 'span',
        attributes : {
            role : 'checkbox',
            disabled : function(name, value) {
                this.result.setAttribute('aria-disabled', value || 'false');
            },
            tabindex : function(name, value) {
                if(this.element.getAttribute('disabled') !== 'true') return '0';
            },
            checked : function(name, value) {
                if(value) this.result.setAttribute('aria-checked', value);
            },
            view : function(name, value) {
                var view = value || 'checkbox';
                this.result.classList.add(view);
                if(view === 'checkbox') {
                    var box = this.createElement('span', { 'class' : 'box' });
                    this.result.appendChild(box);
                }
            }
        },
        never : function() {
            this.create({ tagName : 'span', className : 'box' });
            this.create('span', { 'class' : 'box' });
            this.sourceElement;
            this.targetElement;

            //this.getClass();
            this.hasClass('button');

            //this.setClass('button shadow');
            this.addClass('link');
            //this.removeClass('link');
            //this.toggleClass('focus');

            this.getAttr('disabled');
            this.hasAttr('checked');
            this.setAttr('aria-checked', 'true');
            //this.removeAttr('aria-disabled');
        }
    });

    /*void function() {
        DOMARIATransform.prototype.elements.radiogroup = new DOMARIATransform();
    }();

    new DOMElementTransform('radiogroup', { aria : true });

    void function() {
        var radio = new DOMARIATransform();
        radio.transform = function(node) {
            var result = Object.getPrototypeOf(this).transform.call(this, node),
                radiogroup = node.closest('radiogroup'),
                first = radiogroup.querySelector('radio'),
                checked = radiogroup.querySelector('radio[checked=true]'),
                disabled = node.getAttribute('disabled') === 'true' ||
                    radiogroup.getAttribute('disabled') === 'true';
            if(!disabled)
                result.tabIndex = (!checked && node === first) || node === checked? 0 : -1;
            return result;
        }
        radio.applyChildNodes = function(node, result) {
            result.appendChild(this.createBoxElement());
            Object.getPrototypeOf(this).applyChildNodes.call(this, node, result);
        }
        DOMARIATransform.prototype.elements.radio = radio;
    }();

    new DOMARIATransform('radio', {
        before : 'box',
        tabindex : -1
    });

    void function() {
        var listbox = new DOMARIATransform();
        listbox.transform = function(node) {
            var result = Object.getPrototypeOf(this).transform.call(this, node);
            this.setTabIndex(node, result);
            return result;
        }
        listbox.applyChildNodes = function(node, result) {
            result.appendChild(this.box = this.createBoxElement());
            Object.getPrototypeOf(this).applyChildNodes.call(this, node, result);
        }
        listbox.appendChild = function(child, result) {
            this.box.appendChild(child);
        }
        DOMARIATransform.prototype.elements.listbox = listbox;
    }();

    void function() {
        DOMARIATransform.prototype.elements.option = new DOMARIATransform();
    }();

    new DOMElementTransform('option', { aria : { role : true, attributes : true }, view : true });

    void function() {
        var textbox = new DOMARIATransform();
        textbox.transform = function(node) {
            var result = Object.getPrototypeOf(this).transform.call(this, node),
                box = document.createElement('input'),
                value = node.getAttribute('value');
            box.setAttribute('autocomplete', 'off');
            box.classList.add('box');
            if(typeof value === 'string') box.setAttribute('value', value);
            if(node.getAttribute('disabled') === 'true') {
                result.classList.add('disabled');
                box.disabled = true;
            }
            result.appendChild(box);
            return result;
        }
        textbox.nodeName = function(node) {
            return 'label';
        }
        DOMARIATransform.prototype.elements.textbox = textbox;
    }();*/
</script>
</body>
</html>

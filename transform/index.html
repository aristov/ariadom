<!doctype html>
<html>
<head>
    <meta charset=utf-8>
    <meta name=viewport content="width=device-width,maximum-scale=1,initial-scale=1,user-scalable=0">

    <title>ARIADOM: Yandex style</title>

    <script src=../design/role.js></script>
    <script src=../design/ARIAButton.js></script>
    <script src=../design/ARIACheckBox.js></script>
    <script src=../design/ARIARadioGroup.js></script>
    <script src=../design/ARIAListBox.js></script>
    <script src=../design/ARIAHTMLTextBox.js></script>
    <script>
        ARIAButton.attachToDocument();
        ARIACheckBox.attachToDocument();
        ARIARadioGroup.attachToDocument();
        ARIAListBox.attachToDocument();
        ARIAHTMLTextBox.attachToDocument();

        document.addEventListener('click', function() {}); // cure for iOS
    </script>
    <script src=domTransform.js></script>

    <link rel=stylesheet href=../style/yandex.css>
    <style>
        article
        {
            display: inline-block;
            padding: 0 20px;
            margin-right: 80px;
            vertical-align: top;
        }
        section
        {
            margin: 20px 0;
        }
    </style>
</head>
<body>
<script>
    var xhr = new XMLHttpRequest(),
        domTransform = new DOMTransform();

    xhr.addEventListener('load', onLoad);
    xhr.open('GET', 'index.xml');
    xhr.send();

    function onLoad(event) {
        var ts = Date.now(),
            root = this.responseXML.documentElement,
            don = domTransform.apply(root),
            result = domTransform.build(don);

        document.body.appendChild(result);
        console.log(Date.now() - ts);
        console.dir(don);
    }

    //================================================================================================

    domTransform.element('root', { element : 'div' });

    domTransform.element('heading', {
        element : function(name, heading) {
            return 'h' + (heading.getAttribute('level') || '1');
        },
        attributes : undefined
    });

    domTransform.element('link', {
        element : 'a',
        attributes : function(attrs) {
            return {
                href : attrs.href,
                rel : attrs.rel,
                'class' : [attrs.view || 'link', attrs.mix].join(' ')
            };
        }
    });

    domTransform.element('button', {
        element : 'span',
        attributes : function(attrs) {
            return {
                role : 'button',
                tabindex : attrs.disabled === 'true'? undefined : '0',
                'aria-disabled' : attrs.disabled,
                'aria-pressed' : attrs.pressed,
                'class' : attrs.view || 'button'
            }
        }
    });

    domTransform.element('checkbox', {
        element : 'span',
        attributes : function(attrs) {
            return {
                role : 'checkbox',
                tabindex : attrs.disabled === 'true'? undefined : '0',
                'aria-disabled' : attrs.disabled,
                'aria-checked' : attrs.checked,
                'class' : (this.view = attrs.view || 'checkbox')
            }
        },
        children : function(children, checkbox) {
            return this.view === 'checkbox'? [
                {
                    element : 'span',
                    attributes : { 'class' : 'box' }
                },
                checkbox.textContent
            ] : this.apply(children)
        }
    });

    domTransform.element('radiogroup', {
        element : 'span',
        attributes : function(attrs, radiogroup) {
            return {
                role : 'radiogroup',
                'aria-label' : attrs.label,
                'aria-disabled' : attrs.disabled,
                'class' : attrs.view || 'radiogroup'
            };
        },
        transform : function(radiogroup) {
            if(radiogroup.getAttribute('disabled') === 'true') {
                Array
                    .from(radiogroup.querySelectorAll('radio'))
                    .forEach(function(radio) {
                        radio.setAttribute('disabled', 'true');
                    });
            } else {
                (radiogroup.querySelector('radio[checked=true]') ||
                    radiogroup.querySelector('radio'))
                        .setAttribute('tabindex', '0');
            }
            return this.base.transform.call(this, radiogroup);
        }
    });

    domTransform.element('radio', {
        element : 'span',
        attributes : function(attrs, radio) {
            return {
                role : 'radio',
                tabindex : attrs.disabled === 'true'?
                    undefined :
                    attrs.tabindex || '-1',
                'aria-checked' : attrs.checked,
                'aria-disabled' : attrs.disabled,
                'class' : (this.view = attrs.view || 'radio')
            };
        },
        children : function(children, radio) {
            return this.view === 'radio'? [
                {
                    element : 'span',
                    attributes : { 'class' : 'box' }
                },
                radio.textContent
            ] : this.apply(children);
        }
    });

    domTransform.element('listbox', {
        element : 'span',
        attributes : function(attrs) {
            return {
                role : 'listbox',
                tabindex : attrs.disabled === 'true'? undefined : '0',
                'aria-label' : attrs.label,
                'aria-disabled' : attrs.disabled,
                'class' : attrs.view || 'listbox'
            };
        },
        children : function(children) {
            return {
                element : 'span',
                attributes : { 'class' : 'box' },
                children : this.apply(children)
            }
        }
    });

    domTransform.element('option', {
        element : 'span',
        attributes : function(attrs) {
            return {
                role : 'option',
                'aria-selected' : attrs.selected,
                'aria-checked' : attrs.checked,
                'class' : attrs.view || 'option'
            };
        }
    });

    domTransform.element('group', {
        element : 'span',
        attributes : function(attrs) {
            return {
                role : 'group',
                'aria-label' : attrs.label,
                'class' : attrs.view || 'group'
            };
        }
    });

    domTransform.element('textbox', {
        element : 'span',
        attributes : function(attrs) {
            return {
                role : 'textbox',
                'aria-label' : attrs.label,
                'class' : [
                    attrs.view || 'textbox',
                    attrs.disabled && 'disabled'
                ].join(' ').trim()
            }
        },
        children : function(children, textbox) {
            var disabled = textbox.getAttribute('disabled') === 'true'? '' : undefined,
                value = textbox.getAttribute('value') || undefined;
            return textbox.getAttribute('multiline') === 'true'?
                this.textarea(disabled, value) :
                this.input(disabled, value);
        },
        input : function(disabled, value) {
            return {
                element : 'input',
                attributes : {
                    autocomplete : 'off',
                    disabled : disabled,
                    value : value,
                    'class' : 'box'
                }
            }
        },
        textarea : function(disabled, value) {
            return {
                element : 'textarea',
                attributes : {
                    autocomplete : 'off',
                    disabled : disabled,
                    'class' : 'box'
                },
                children : value
            }
        }
    });

    /*domTransform
        .element('textbox')
        .attribute('multiline', 'true')
        .transform({
            children : function(children, textbox) {
                return {
                    element : 'textarea',
                    attributes : {
                        autocomplete : 'off',
                        disabled : this.attrs.disabled,
                        'class' : 'box'
                    },
                    children : this.attrs.value || ''
                };
            }
        });

    domTransform.element({
        name : 'textbox',
        attrName : 'multiline',
        attrValue : 'true'
    }, {
        children : function(children, textbox) {
            return {
                element : 'textarea',
                attributes : {
                    autocomplete : 'off',
                    disabled : this.attrs.disabled,
                    'class' : 'box'
                },
                children : this.attrs.value || ''
            };
        }
    });*/
</script>
</body>
</html>
